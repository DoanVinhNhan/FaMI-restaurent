<div class="card-body cart-scroll p-0">
    <!-- 1. History (Submitted Orders) -->
    {% if active_orders %}
    <div class="bg-light border-bottom p-2">
        <small class="fw-bold text-uppercase text-muted"><i class="bi bi-clock-history me-1"></i>Đã gọi (Chưa thanh
            toán)</small>
    </div>
    <div class="list-group list-group-flush mb-0 border-bottom">
        {% for order in active_orders %}
        {% for detail in order.details.all %}
        <div class="list-group-item bg-light px-3 py-2 d-flex justify-content-between align-items-center opacity-75">
            <div class="me-auto">
                <div class="fw-bold">{{ detail.menu_item.name }}</div>
                <small class="text-muted">{{ detail.quantity }} x ${{ detail.unit_price }}</small>
            </div>
            <div class="text-end">
                <span class="fw-bold d-block">${{ detail.total_price }}</span>
                <span class="badge bg-warning text-dark" style="font-size: 0.65rem;">{{ order.get_status_display
                    }}</span>
            </div>
        </div>
        {% endfor %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- 2. Current Cart (Pending) -->
    {% if pending_order and pending_order.details.exists %}
    <div class="bg-white p-2 border-bottom">
        <small class="fw-bold text-uppercase text-primary"><i class="bi bi-cart me-1"></i>Đang chọn</small>
    </div>
    <div class="list-group list-group-flush">
        {% for detail in pending_order.details.all %}
        <div class="list-group-item px-3 py-2 d-flex justify-content-between align-items-center">
            <div class="me-auto">
                <div class="fw-bold">{{ detail.menu_item.name }}</div>
                <small class="text-muted">${{ detail.unit_price }} x {{ detail.quantity }}</small>
            </div>
            <div class="d-flex align-items-center">
                <span class="fw-bold me-3">${{ detail.total_price }}</span>
                <!-- Remove Button -->
                <button class="btn btn-sm btn-outline-danger border-0"
                    hx-post="{% url 'sales:pos_remove_item' table.table_id detail.id %}" hx-target="#cart-container">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% elif not active_orders %}
    <div class="h-100 d-flex flex-column align-items-center justify-content-center text-muted py-5">
        <i class="bi bi-basket display-1 mb-3 opacity-25"></i>
        <p>Giỏ hàng trống</p>
    </div>
    {% endif %}
</div>

<!-- Footer / Totals -->
<div class="card-footer bg-white border-top p-3">
    <!-- Calculate Grand Total -->
    <div class="d-flex justify-content-between mb-3">
        <span class="fs-5 text-secondary">Tạm tính</span>
        <span class="fs-4 fw-bold text-dark">
            <!-- Simple template math not easy, best to do in view. But for now let's show breakdown or just Pending Total? -->
            <!-- User Requirement: "Chỉ mất đi khi thanh toán". Total should probably be the Table Total. -->
            <!-- Let's sum in template or view. View is cleaner. But I can't easily change context in all views now. -->
            <!-- Let's show Pending Total for now, and maybe a Table Total line if history exists. -->
            {% if pending_order %}${{ pending_order.total_amount }}{% else %}$0.00{% endif %}
        </span>
    </div>

    {% if active_orders %}
    <div class="d-flex justify-content-between mb-2 small text-muted">
        <span>Đã gọi:</span>
        <span>(See Payment)</span>
        <!-- Ideally we sum active_orders.total_amount. -->
    </div>
    {% endif %}

    <div class="d-grid gap-2">
        {% if pending_order and pending_order.details.exists %}
        <form action="{% url 'sales:pos_submit_order' table.table_id %}" method="POST">
            {% csrf_token %}
            <!-- Submit Button (Pending) -->
            <button type="submit" class="btn btn-success btn-lg w-100">
                Gửi xuống Bếp <i class="bi bi-arrow-right ms-2"></i>
            </button>
        </form>
        {% endif %}

        <!-- Payment Actions -->
        <!-- Only show if there are Active Orders (Kitchen) -->
        {% if active_orders %}
        <div class="btn-group-vertical w-100 gap-2">
            <!-- 1. Pay & Mark Empty (Standard Flow) -->
            <a href="{% url 'sales:process_payment' table.table_id %}?action=pay_and_clear"
                class="btn btn-primary btn-lg">
                <i class="bi bi-check-circle-fill me-2"></i>Thanh toán & Trống Bàn
            </a>

            <!-- 2. Pay Only -->
            <a href="{% url 'sales:process_payment' table.table_id %}?action=pay_only" class="btn btn-outline-primary">
                <i class="bi bi-credit-card me-2"></i>Chỉ Thanh toán
            </a>

            <!-- 3. Mark Empty Only (No Payment/Cleanup) -->
            <form action="{% url 'sales:clear_table_status' table.table_id %}" method="POST" class="w-100"
                onsubmit="return confirm('Bạn có chắc chắn muốn đánh dấu bàn này là TRỐNG mà KHÔNG thanh toán?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-eraser me-2"></i>Chỉ Đánh dấu Trống
                </button>
            </form>
        </div>
        {% endif %}

        <a href="{% url 'sales:pos_index' %}" class="btn btn-outline-secondary mt-2">
            Quay lại
        </a>
    </div>
</div>